<project_specification>
  <project_name>MedTracker - Medication Management System</project_name>

  <overview>
    Build a medication tracking application for carers and patients to confidently
    record doses and respect safety rules. The application provides prescription
    management, dose tracking with timing restrictions, and a complete audit trail
    for UK healthcare compliance. The UI uses Hotwire (Turbo + Stimulus) with Phlex
    components for a modern, server-rendered experience.

    Primary outcome: Accurate, auditable history of prescriptions and over-the-counter
    medicines for every Person in the system.
  </overview>

  <technology_stack>
    <backend>
      <framework>Ruby on Rails 8.0</framework>
      <language>Ruby 3.4</language>
      <database>PostgreSQL 18 (all environments)</database>
      <authentication>Rodauth (rodauth-rails, rodauth-omniauth gems)</authentication>
      <authorization>Pundit gem with deny-by-default policies</authorization>
      <audit_logging>PaperTrail gem</audit_logging>
    </backend>
    <frontend>
      <framework>Hotwire (Turbo + Stimulus)</framework>
      <components>Phlex view components in app/components/</components>
      <styling>TailwindCSS</styling>
      <icons>Lucide</icons>
      <dialogs>HTML dialog element with Turbo Streams</dialogs>
    </frontend>
    <testing>
      <framework>RSpec + Capybara</framework>
      <fixtures>Rails fixtures in spec/fixtures/</fixtures>
      <api_mocking>VCR for external HTTP</api_mocking>
      <e2e>Playwright</e2e>
    </testing>
    <deployment>
      <containerization>Docker Compose</containerization>
      <ci_cd>GitHub Actions</ci_cd>
    </deployment>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - PostgreSQL 18 running (via Docker or local installation)
      - Ruby 3.4 installed
      - Node.js for asset compilation
      - Docker for containerized development and testing
    </environment_setup>
    <task_commands>
      - task dev:up: Start development server
      - task dev:stop: Stop development server
      - task dev:logs: View development server logs
      - task dev:seed: Seed database with fixtures
      - task dev:rebuild: Rebuild development server
      - task test: Run tests in Docker
      - task test:rebuild: Rebuild test server
    </task_commands>
    <test_users>
      All users have password: password

      Administrators:
        - damacus@example.com
        - admin@example.com

      Medical Staff:
        - dr.jones@example.com (doctor)
        - nurse.smith@example.com (nurse)

      Carers:
        - bob.smith@example.com
        - carer@example.com

      Parents:
        - jane.doe@example.com
        - parent@example.com
    </test_users>
  </prerequisites>

  <core_features>
    <prescription_management>
      - Create and manage prescriptions with dosage, frequency, start/end dates
      - Track active vs inactive prescriptions
      - Set timing restrictions (max_daily_doses, min_hours_between_doses)
      - Support daily, weekly, and monthly dosing schedules
      - Link prescriptions to specific people and medicines
      - Special instructions field for additional notes
    </prescription_management>

    <dose_tracking>
      - Log each dose with timestamp and amount (MedicationTake model)
      - Track who administered the dose (administered_by user_id)
      - Validate against prescription rules before allowing recording
      - Support both prescription and non-prescription medicines
      - Notes field for recording observations
      - Constraint: exactly one of prescription_id or person_medicine_id required
    </dose_tracking>

    <person_medicines>
      - Track vitamins, supplements, and OTC medications without prescriptions
      - Optional timing restrictions (max_daily_doses, min_hours_between_doses)
      - can_take_now? method determines if medicine can be taken
      - next_available_time calculates when medicine can next be taken
      - UI button automatically disables when restrictions prevent taking
      - Shows next available time when button is disabled
    </person_medicines>

    <timing_restrictions>
      - Max daily doses: Limits number of times medicine can be taken per day
      - Min hours between doses: Enforces minimum time between doses
      - Enforced at model level before UI
      - Clear feedback when restrictions prevent taking
      - Applies to both prescriptions and person_medicines
    </timing_restrictions>

    <dashboard>
      - Role-based data scoping (each role sees appropriate data)
      - Admin/Doctor/Nurse: See all people and prescriptions
      - Carer: See only assigned patients
      - Parent: See only their minor children
      - Patient: See only themselves
      - Shows people and their active prescriptions
      - Quick access to medication recording
    </dashboard>

    <admin_interface>
      User Management (Admin::UsersController):
        - Index with search, filtering, pagination (Pagy, 20 per page)
        - Create new users with role assignment
        - Edit user details and roles
        - Activate/deactivate accounts (soft delete pattern)
        - Nested person creation on user form
        - Sortable columns (name, email, created_at)

      Admin Dashboard:
        - Total users by role
        - Total people by type
        - Recent signups (last 7 days)
        - Active users count
        - Warning for patients without capacity lacking carers
        - Quick links to manage users/people
    </admin_interface>

    <audit_trail>
      - PaperTrail gem for complete audit logging
      - Audited models: User, Person, CarerRelationship, MedicationTake
      - Filter by record type and event type
      - View complete change history with timestamps
      - See who made changes and from which IP address
      - View previous state before changes
      - Read-only interface (no editing/deletion of audit logs)
      - URL: /admin/audit_logs (administrator role only)
      - Retained indefinitely for regulatory compliance
    </audit_trail>
  </core_features>

  <database_schema>
    <tables>
      <accounts>
        - id (primary key)
        - email (unique, not null)
        - password_hash
        - status (enum: unverified, verified, closed)
        - created_at, updated_at
        Managed by Rodauth
      </accounts>

      <people>
        - id (primary key)
        - account_id (optional foreign key to accounts)
        - name (string, required)
        - email (string)
        - date_of_birth (date, required)
        - person_type (enum: adult=0, minor=1, dependent_adult=2)
        - has_capacity (boolean, default true)
        - created_at, updated_at
      </people>

      <users>
        - id (primary key)
        - person_id (foreign key to people)
        - email (unique, required)
        - password_digest (for legacy auth, being migrated to Rodauth)
        - role (enum: administrator=0, doctor=1, nurse=2, carer=3, parent=4)
        - active (boolean, default true)
        - created_at, updated_at
      </users>

      <medicines>
        - id (primary key)
        - name (string, required)
        - description (text)
        - active (boolean, default true)
        - standard_dosage (string)
        - warnings (text)
        - created_at, updated_at
      </medicines>

      <prescriptions>
        - id (primary key)
        - person_id (foreign key to people, required)
        - medicine_id (foreign key to medicines, required)
        - dosage (string)
        - frequency (string)
        - start_date (date, required)
        - end_date (date, optional)
        - active (boolean, default true)
        - max_daily_doses (integer, optional)
        - min_hours_between_doses (integer, optional)
        - special_instructions (text)
        - created_at, updated_at
      </prescriptions>

      <person_medicines>
        - id (primary key)
        - person_id (foreign key to people, required)
        - medicine_id (foreign key to medicines, required)
        - notes (text)
        - max_daily_doses (integer, optional)
        - min_hours_between_doses (integer, optional)
        - created_at, updated_at
        Unique index on [person_id, medicine_id]
      </person_medicines>

      <medication_takes>
        - id (primary key)
        - prescription_id (foreign key, nullable)
        - person_medicine_id (foreign key, nullable)
        - taken_at (datetime, required)
        - amount_ml (decimal)
        - administered_by (user_id)
        - notes (text)
        - created_at, updated_at
        Constraint: exactly one of prescription_id or person_medicine_id must be present
      </medication_takes>

      <carer_relationships>
        - id (primary key)
        - carer_id (foreign key to people, required)
        - patient_id (foreign key to people, required)
        - relationship_type (string)
        - active (boolean, default true)
        - created_at, updated_at
        Unique index on [carer_id, patient_id]
      </carer_relationships>

      <sessions>
        - id (primary key)
        - user_id (foreign key to users)
        - ip_address (string)
        - user_agent (string)
        - created_at, updated_at
      </sessions>

      <versions>
        - id (primary key)
        - item_type (string, required)
        - item_id (bigint, required)
        - event (string: create, update, destroy)
        - whodunnit (string, user_id who made change)
        - ip (string, IP address)
        - object (text, YAML snapshot before change)
        - created_at (datetime)
        PaperTrail audit log table
      </versions>
    </tables>
  </database_schema>

  <user_roles>
    <role name="administrator">
      - Full system access
      - Manage all users
      - View all people
      - Create patients
      - Manage prescriptions
      - Record medications
      - Assign carers
      - View audit logs
    </role>

    <role name="doctor">
      - Clinical access
      - View all people
      - Create patients
      - Manage prescriptions
      - Record medications
      - Assign carers
    </role>

    <role name="nurse">
      - Clinical access
      - View all people
      - Create patients
      - Record medications
      - Assign carers
    </role>

    <role name="carer">
      - Access to assigned patients only
      - Edit own profile
      - Record medications for assigned patients
    </role>

    <role name="parent">
      - Access to their minor children only
      - Edit own profile
      - Record medications for their children
    </role>
  </user_roles>

  <person_types>
    <type name="adult" value="0">
      Self-managing adult with capacity
      adult? returns true if age >= 18 OR person_type == 'adult'
    </type>

    <type name="minor" value="1">
      Child requiring parental consent
      minor? returns true if age < 18 AND person_type == 'minor'
      Always lacks capacity due to age
    </type>

    <type name="dependent_adult" value="2">
      Adult requiring carer support
      dependent_adult? returns true if age >= 18 AND person_type == 'dependent_adult'
      Lacks capacity due to medical/cognitive reasons
    </type>

    <helper_method name="needs_carer?">
      Returns true if (minor? OR dependent_adult?) AND carers.empty?
    </helper_method>
  </person_types>

  <authorization_policies>
    <policy name="ApplicationPolicy">
      Base deny-by-default policy
      All actions return false unless explicitly permitted
    </policy>

    <policy name="UserPolicy">
      - index?: administrator only
      - show?: administrator or own record
      - create?: administrator only
      - update?: administrator or own record
      - destroy?: administrator only (soft delete)
    </policy>

    <policy name="PersonPolicy">
      - index?: administrator, doctor, nurse (see all); carer/parent (see assigned)
      - show?: administrator, doctor, nurse, or assigned carer/parent
      - create?: administrator, doctor, nurse
      - update?: administrator, doctor, nurse, or assigned carer/parent
      - destroy?: administrator only
    </policy>

    <policy name="PrescriptionPolicy">
      - index?: all authenticated users (scoped by role)
      - show?: administrator, doctor, nurse, or assigned carer/parent
      - create?: administrator, doctor
      - update?: administrator, doctor
      - destroy?: administrator, doctor
      - take_medicine?: administrator, doctor, nurse, or assigned carer/parent
    </policy>

    <policy name="MedicinePolicy">
      - index?: all authenticated users
      - show?: all authenticated users
      - create?: administrator, doctor
      - update?: administrator, doctor
      - destroy?: administrator only
    </policy>

    <policy name="PersonMedicinePolicy">
      - index?: all authenticated users (scoped by role)
      - show?: administrator, doctor, nurse, or assigned carer/parent
      - create?: administrator, doctor, nurse, or assigned carer/parent
      - update?: administrator, doctor, nurse, or assigned carer/parent
      - destroy?: administrator, doctor, nurse, or assigned carer/parent
      - take_medicine?: administrator, doctor, nurse, or assigned carer/parent
    </policy>

    <policy name="MedicationTakePolicy">
      - create?: administrator, doctor, nurse, or assigned carer/parent
      - Scope: filters by role (admin/doctor/nurse see all, others see assigned)
    </policy>

    <policy name="DashboardPolicy">
      - index?: all authenticated users
      - Scoping: admin/doctor/nurse see all; carer sees assigned; parent sees children
    </policy>

    <policy name="CarerRelationshipPolicy">
      - index?: administrator, doctor, nurse (all); carer/parent (own relationships)
      - create?: administrator, doctor, nurse
      - destroy?: administrator, doctor, nurse
    </policy>

    <policy name="AuditLogPolicy">
      - index?: administrator only
      - show?: administrator only
    </policy>
  </authorization_policies>

  <authentication>
    <current_state status="partial" completion="20%">
      What works:
        - Rodauth gems installed (rodauth-rails, rodauth-omniauth)
        - Account model exists with Rodauth integration
        - Login/logout via Rodauth (/login endpoint)
        - current_account helper available
        - Account-Person relationship exists

      What's missing (CRITICAL):
        - Rodauth signup form (legacy UsersController still in use)
        - Email verification flow
        - Google OAuth integration
        - Person creation on signup
        - Migration of existing users to Account model
    </current_state>

    <target_architecture>
      <data_model>
        - Account table managed by Rodauth (email, password_hash, status, verification)
        - Person belongs_to Account (optional - minors/dependents have no account)
        - Only people who access the app directly have accounts
      </data_model>

      <email_verification>
        Production:
          - Unverified accounts CANNOT sign in
          - Must verify email before first login
          - No grace period

        Non-Production (development, test, staging):
          - Unverified accounts CAN sign in for 7 days after creation
          - After 7 days, verification required
          - Allows testing without email setup
      </email_verification>

      <google_oauth>
        - New Google user: create Account + Person, mark verified
        - Existing email: link Google identity to existing account
        - Logged-in user: can link Google from settings
      </google_oauth>

      <email_provider>
        Postmark (chosen for UK/EU data residency, GDPR compliance)
        Development: letter_opener gem for email preview
      </email_provider>
    </target_architecture>
  </authentication>

  <implementation_phases>
    <phase number="1.1" title="Authorization Framework" status="complete">
      - Add Pundit gem
      - Create ApplicationPolicy (deny-by-default)
      - Create policies for all models
      - Add authorization to all controllers
      - Write policy tests
    </phase>

    <phase number="1.2" title="Default Role Assignment" status="complete">
      - Change default user role from administrator to parent
      - Update UsersController to set person_type based on role
    </phase>

    <phase number="1.3" title="Account Security" status="in_progress" priority="critical">
      Tasks:
        - Complete Rodauth signup form
        - Implement email verification flow
        - Add Google OAuth integration
        - Remove legacy authentication code
        - Migrate existing users to Account model

      This phase is blocking user onboarding.
    </phase>

    <phase number="2.1" title="Admin CRUD Operations" status="complete">
      - Admin::UsersController with full CRUD
      - User creation with role assignment
      - User editing and role changes
      - Activate/deactivate accounts
      - Nested person creation
    </phase>

    <phase number="2.2" title="Admin Dashboard" status="complete">
      - Dashboard with metrics
      - User counts by role
      - People counts by type
      - Recent signups
      - Warning for patients without carers
    </phase>

    <phase number="2.3" title="User Search and Filtering" status="complete">
      - Search by name, email
      - Filter by role and active status
      - Pagination with Pagy
      - Sortable columns
    </phase>

    <phase number="3.1" title="Carer Assignment Interface" status="not_started" priority="high">
      - CarerRelationshipsController
      - UI to assign carers to patients
      - UI to view/manage relationships
      - Relationship type selection
    </phase>

    <phase number="3.2" title="Patient Dashboard for Carers" status="not_started" priority="high">
      - List of assigned patients
      - Patient medication schedules
      - Quick medication recording
    </phase>

    <phase number="3.3" title="Capacity Validation" status="not_started" priority="high">
      - Model validation: patients without capacity must have carers
      - Admin warning for non-compliant records
      - UI to assign carer when creating patient without capacity
    </phase>

    <phase number="4.1" title="User Profile Management" status="not_started" priority="medium">
      - ProfilesController
      - View and edit own profile
      - Change email (with confirmation)
      - Change password
    </phase>

    <phase number="4.2" title="User Settings" status="not_started" priority="medium">
      - Settings page
      - Notification preferences
      - Timezone selection
    </phase>

    <phase number="4.3" title="Account Deletion" status="not_started" priority="medium">
      - Soft delete for users
      - Confirmation dialog
      - Admin reactivation option
    </phase>

    <phase number="5.1" title="User Invitation System" status="not_started" priority="low">
      - InvitationsController
      - Generate invitation tokens
      - Send invitation emails
      - Invitation acceptance flow
    </phase>

    <phase number="5.2" title="Two-Factor Authentication" status="not_started" priority="low">
      - TOTP via rotp gem
      - QR code generation via rqrcode
      - 10 backup codes per user
      - Optional initially, mandatory for admin/medical roles later
    </phase>

    <phase number="5.3" title="Admin Impersonation" status="not_started" priority="low">
      - Impersonate users for support
      - Clear visual indicator when impersonating
      - Log impersonation actions
    </phase>
  </implementation_phases>

  <key_directories>
    <directory path="app/">Rails MVC + Phlex components</directory>
    <directory path="app/components/">Phlex view components</directory>
    <directory path="app/controllers/">Rails controllers</directory>
    <directory path="app/controllers/admin/">Admin namespace controllers</directory>
    <directory path="app/models/">ActiveRecord models</directory>
    <directory path="app/policies/">Pundit authorization policies</directory>
    <directory path="app/misc/">Rodauth configuration</directory>
    <directory path="spec/">RSpec and Capybara tests</directory>
    <directory path="spec/fixtures/">Test data fixtures</directory>
    <directory path="spec/models/">Model specs</directory>
    <directory path="spec/policies/">Policy specs</directory>
    <directory path="spec/features/">System/feature specs</directory>
    <directory path="spec/components/">Phlex component specs</directory>
    <directory path="config/">Environment and routes</directory>
    <directory path="db/migrate/">Schema migrations</directory>
    <directory path="docs/">Documentation</directory>
    <directory path="docs/plans/">Implementation plans (being consolidated)</directory>
  </key_directories>

  <security_considerations>
    <authentication>
      - Rodauth with bcrypt password hashing
      - Minimum 8 character passwords
      - Session fixation protection
      - Remember me tokens rotated
      - IP and user-agent tracking
    </authentication>

    <authorization>
      - Deny-by-default Pundit policies
      - Role-based access control
      - Data scoping by user role
      - CSRF protection enabled
    </authorization>

    <data_protection>
      - PostgreSQL with encrypted connections
      - Audit logging for all changes
      - Password fields excluded from audit logs
      - UK/EU data residency (Postmark for email)
    </data_protection>

    <compliance>
      - UK GDPR compliant
      - DCB0129 Clinical Risk Management
      - DCB0160 Clinical Safety
      - NHS Data Security and Protection Toolkit compatible
    </compliance>
  </security_considerations>

  <development_rules>
    <tdd>
      Every line of production code must be written in response to a failing test.
      Follow strict Red-Green-Refactor cycle.
      Write behavior-driven tests from user perspective.
      Test public APIs only, not implementation details.
    </tdd>

    <code_style>
      - Ruby Style Guide enforced by RuboCop
      - Self-documenting code preferred over comments
      - Guard clauses for early returns
      - Service objects for complex business logic
      - Keep controllers and models clean and focused
    </code_style>

    <commits>
      - Conventional Commits format (feat:, fix:, refactor:, test:)
      - Small, atomic commits focused on single changes
      - All tests must pass before merge
    </commits>

    <testing>
      - RSpec for all tests
      - Capybara for system tests
      - Fixtures for test data (realistic, no duplicates)
      - VCR for external API mocking
      - Playwright for E2E tests
    </testing>
  </development_rules>

  <success_criteria>
    <functionality>
      - Prescription management with timing restrictions works correctly
      - Dose tracking validates against prescription rules
      - Role-based authorization enforced throughout
      - Audit trail captures all changes
      - Dashboard shows appropriate data per role
    </functionality>

    <user_experience>
      - Clean, modern UI with Phlex components
      - Responsive design for all device sizes
      - Clear feedback for all actions
      - Intuitive navigation
      - Accessible (ARIA labels, keyboard navigation)
    </user_experience>

    <technical_quality>
      - 100% test coverage for policies
      - No N+1 queries
      - Proper error handling throughout
      - Clean, maintainable code structure
      - All RuboCop checks pass
    </technical_quality>

    <compliance>
      - UK GDPR compliant
      - DCB0129/DCB0160 clinical safety
      - Complete audit trail
      - Secure authentication
    </compliance>
  </success_criteria>

  <future_considerations>
    - Mobile application support
    - Medication schedule reminders
    - Integration with pharmacy systems
    - Export/reporting capabilities
    - Multiple timezone support
    - Offline capabilities
    - PWA support
  </future_considerations>
</project_specification>
