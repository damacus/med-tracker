---
# Internal Tasks - Reusable Docker Compose operations
# These tasks are marked 'internal: true' and should only be called by other taskfiles
# They require ENVIRONMENT variable (dev, test, or prod) to select the compose profile
#
# Uses a single compose.yaml with profiles instead of separate docker-compose.*.yml files.
# COMPOSE_PROJECT_NAME is derived from the directory basename to support multiple worktrees.
version: "3"

vars:
  COMPOSE_PROJECT:
    sh: basename (pwd)
  COMPOSE_CMD: docker compose -p {{ .COMPOSE_PROJECT }}

tasks:
  # Execute arbitrary commands in Docker containers
  # Required vars: ENVIRONMENT, COMMAND
  # SERVICE is auto-derived as web-{{ .ENVIRONMENT }}
  # Example: task internal:run ENVIRONMENT=test COMMAND='rails console'
  run:
    desc: Run arbitrary command in Docker container
    internal: true
    requires:
      vars: [ENVIRONMENT, COMMAND]
    vars:
      SERVICE: "web-{{ .ENVIRONMENT }}"
    cmds:
      - "{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} run --rm {{ .SERVICE }} {{ .COMMAND }}"

  # Build Docker images for specified environment
  # Required vars: ENVIRONMENT
  # Optional vars: NO_CACHE (set to "true" to force rebuild)
  # Example: task internal:build ENVIRONMENT=test NO_CACHE=true
  build:
    desc: Build Docker images
    silent: false
    internal: true
    requires:
      vars: [ENVIRONMENT]
    vars:
      NO_CACHE: '{{ .NO_CACHE | default "" }}'
    cmds:
      - "{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} build {{ if .NO_CACHE }}--no-cache{{ end }}"

  # Start Docker containers in detached mode
  # Required vars: ENVIRONMENT
  # Removes orphaned containers and starts services
  # Example: task internal:up ENVIRONMENT=dev
  up:
    desc: Start Docker containers
    internal: true
    requires:
      vars: [ENVIRONMENT]
    cmds:
      - "{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} up -d"
      - echo "✓ {{ .ENVIRONMENT | title }} environment started"

  # Stop and remove Docker containers
  # Required vars: ENVIRONMENT
  # This removes containers but preserves volumes (database data)
  # Example: task internal:stop ENVIRONMENT=test
  stop:
    desc: Stop and remove Docker containers
    internal: true
    requires:
      vars: [ENVIRONMENT]
    vars:
      REMOVE_VOLUMES: '{{ .REMOVE_VOLUMES | default "false" }}'
    cmds:
      - '{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} down {{ if eq .REMOVE_VOLUMES "true" }}-v{{ end }}'
      - echo "✓ {{ .ENVIRONMENT | title }} environment stopped"

  db-migrate:
    desc: Run Rails migrations
    internal: true
    requires:
      vars: [ENVIRONMENT]
    vars:
      SERVICE: "web-{{ .ENVIRONMENT }}"
    cmds:
      - "{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} run --rm {{ .SERVICE }} rails db:migrate"

  # Follow logs from Docker containers
  # Press Ctrl+C to stop following logs
  # Example: task internal:logs ENVIRONMENT=dev
  logs:
    desc: Follow container logs
    internal: true
    requires:
      vars: [ENVIRONMENT]
    cmds:
      - "{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} logs -f"

  ps:
    desc: Get current status of Docker Compose Stack
    internal: true
    requires:
      vars: [ENVIRONMENT]
    cmds:
      - "{{ .COMPOSE_CMD }} --profile {{ .ENVIRONMENT }} ps"

  seed:
    desc: Seed database with fixtures
    summary: |
      Seed database with fixtures
      Required vars: ENVIRONMENT
      Loads data from db/seeds.rb
      Example: task internal:seed ENVIRONMENT=test
    internal: true
    requires:
      vars: [ENVIRONMENT]
    cmds:
      - echo "Seeding {{ .ENVIRONMENT }} database..."
      - task: run
        vars:
          ENVIRONMENT: { ref: .ENVIRONMENT }
          COMMAND: "rails db:seed"
      - defer: echo "✓ Database seeding completed"

  open-ui:
    desc: Open WebUI
    internal: true
    requires:
      vars: [ENVIRONMENT]
    cmds:
      - |
        PORT=$(docker ps --format {{`"{{.Ports}}"`}} -f name={{ .COMPOSE_PROJECT }}-web-{{ .ENVIRONMENT }} | grep -oE '0\.0\.0\.0:[0-9]+' | cut -d':' -f2)
        if [ -z "$PORT" ]; then
          echo "Error: Could not find running container {{ .COMPOSE_PROJECT }}-web-{{ .ENVIRONMENT }}"
          echo "Run 'task {{.ENVIRONMENT}}:up' first to start the {{.ENVIRONMENT}} server"
          exit 1
        fi
        echo "Opening http://localhost:$PORT/admin/users in Google Chrome..."
        sleep 2
        open -a "Google Chrome" "http://localhost:$PORT/admin/users"
