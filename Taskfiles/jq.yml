---
version: 3
tasks:
  update-field:
    desc: Update a field in a JSON file by ID
    summary: |
      Updates a specific field in a JSON array by matching an ID.

      Usage:
        task jq:update-field FILE=tests.json ID=PROF-002 FIELD=passes VALUE=true

      Examples:
        # Mark a test as passing
        task jq:update-field FILE=features/security.json ID=SEC-001 FIELD=passes VALUE=true

        # Update a description
        task jq:update-field FILE=features/security.json ID=SEC-001 FIELD=description VALUE='"New description"'

      Note: String values must be wrapped in quotes, e.g., VALUE='"my string"'
            Boolean/numeric values are passed directly, e.g., VALUE=true or VALUE=42
    requires:
      vars: [FILE, ID, FIELD, VALUE]
    cmds:
      - |
        jq --arg targetId "{{ .ID }}" --argjson value {{ .VALUE }} 'map(if .id == $targetId then .{{ .FIELD }} = $value else . end)' "{{ .FILE }}" | sponge "{{ .FILE }}"

  query:
    desc: Run a jq query on a JSON file
    summary: |
      Run an arbitrary jq query on a JSON file.

      Usage:
        task jq:query FILE=tests.json QUERY='.[] | select(.passes == false) | .description'

      Examples:
        # Get all failing test descriptions
        task jq:query FILE=features/security.json QUERY='.[] | select(.passes == false) | .description'

        # Get IDs of all items in a category
        task jq:query FILE=features/security.json QUERY='.[] | select(.category == "functional") | .id'
    requires:
      vars: [FILE, QUERY]
    cmds:
      - |
        jq '{{ .QUERY }}' "{{ .FILE }}"

  list-failing:
    desc: List all items with passes=false
    summary: |
      Lists descriptions of all items where passes is false.

      Usage:
        task jq:list-failing FILE=security
    requires:
      vars: [FILE]
    cmds:
      - |
        jq -r '.[] | select(.passes == false) | "\(.id): \(.description)"' "features/{{ .FILE }}.json"
