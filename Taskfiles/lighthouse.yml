---
version: "3"

tasks:
  run:
    desc: Run Lighthouse audit on dashboard (requires dev server running)
    summary: |
      Run Lighthouse mobile audit on the dashboard page
      Requires: task dev:up to be running
      Output: lighthouse-report.json and lighthouse-report.html
      Usage: task lighthouse:run
      Usage: task lighthouse:run URL=http://localhost:3000/medicines
    vars:
      URL: '{{ .URL | default "http://localhost:3000/dashboard" }}'
    cmds:
      - |
        echo "Running Lighthouse audit on {{ .URL }}..."
        npx lighthouse {{ .URL }} \
          --output=json,html \
          --output-path=./lighthouse-report \
          --chrome-flags="--headless --no-sandbox" \
          --form-factor=mobile \
          --screenEmulation.mobile=true \
          --screenEmulation.width=375 \
          --screenEmulation.height=812 \
          --only-categories=accessibility,best-practices,performance
      - task: summary

  summary:
    desc: Display Lighthouse score summary
    summary: |
      Parse and display Lighthouse scores from the latest report
      Usage: task lighthouse:summary
    cmds:
      - |
        if [ -f lighthouse-report.json ]; then
          echo ""
          echo "═══════════════════════════════════════════"
          echo "         LIGHTHOUSE MOBILE SCORES          "
          echo "═══════════════════════════════════════════"
          node -e "
            const r = require('./lighthouse-report.json');
            console.log('Performance:     ' + Math.floor(r.categories.performance.score * 100) + '%');
            console.log('Accessibility:   ' + Math.floor(r.categories.accessibility.score * 100) + '%');
            console.log('Best Practices:  ' + Math.floor(r.categories['best-practices'].score * 100) + '%');
          "
          echo "═══════════════════════════════════════════"
          echo ""
          echo "Full report: lighthouse-report.html"
        else
          echo "No lighthouse-report.json found. Run 'task lighthouse:run' first."
          exit 1
        fi

  ci:
    desc: Run Lighthouse audit for CI (fails if scores below threshold)
    summary: |
      Run Lighthouse audit and fail if scores are below thresholds
      Default thresholds: Performance 70%, Accessibility 85%, Best Practices 85%
      Usage: task lighthouse:ci
      Usage: task lighthouse:ci URL=http://localhost:3000/login
      Usage: task lighthouse:ci PERF_THRESHOLD=60 A11Y_THRESHOLD=80 BP_THRESHOLD=80
    vars:
      URL: '{{ .URL | default "http://localhost:3000/login" }}'
      PERF_THRESHOLD: '{{ .PERF_THRESHOLD | default "70" }}'
      A11Y_THRESHOLD: '{{ .A11Y_THRESHOLD | default "85" }}'
      BP_THRESHOLD: '{{ .BP_THRESHOLD | default "85" }}'
      REPORT_PATH: '{{ .REPORT_PATH | default "./lighthouse-report" }}'
    cmds:
      - |
        set -euo pipefail
        echo "Running Lighthouse CI audit on {{ .URL }}..."
        npx lighthouse {{ .URL }} \
          --output=json,html \
          --output-path={{ .REPORT_PATH }} \
          --chrome-flags="--headless --no-sandbox --disable-gpu" \
          --form-factor=mobile \
          --screenEmulation.mobile=true \
          --screenEmulation.width=375 \
          --screenEmulation.height=812 \
          --only-categories=accessibility,best-practices,performance
      - |
        set -euo pipefail
        REPORT_FILE="{{ .REPORT_PATH }}.json"
        echo ""
        echo "═══════════════════════════════════════════"
        echo "         LIGHTHOUSE MOBILE SCORES          "
        echo "═══════════════════════════════════════════"

        PERF=$(node -e "console.log(Math.floor(require('$REPORT_FILE').categories.performance.score * 100))")
        A11Y=$(node -e "console.log(Math.floor(require('$REPORT_FILE').categories.accessibility.score * 100))")
        BP=$(node -e "console.log(Math.floor(require('$REPORT_FILE').categories['best-practices'].score * 100))")

        echo "Performance:     ${PERF}% (threshold: {{ .PERF_THRESHOLD }}%)"
        echo "Accessibility:   ${A11Y}% (threshold: {{ .A11Y_THRESHOLD }}%)"
        echo "Best Practices:  ${BP}% (threshold: {{ .BP_THRESHOLD }}%)"
        echo "═══════════════════════════════════════════"

        FAILED=0
        if [ "$PERF" -lt "{{ .PERF_THRESHOLD }}" ]; then
          echo "❌ Performance score below threshold!"
          FAILED=1
        fi
        if [ "$A11Y" -lt "{{ .A11Y_THRESHOLD }}" ]; then
          echo "❌ Accessibility score below threshold!"
          FAILED=1
        fi
        if [ "$BP" -lt "{{ .BP_THRESHOLD }}" ]; then
          echo "❌ Best Practices score below threshold!"
          FAILED=1
        fi

        if [ "$FAILED" -eq 1 ]; then
          echo ""
          echo "Top 10 failed audits:"
          node -e "const r=require('$REPORT_FILE');Object.entries(r.audits).filter(([k,v])=>v.score!=null&&v.score<1).map(([k,v])=>({title:v.title,score:Math.floor(v.score*100)})).sort((a,b)=>a.score-b.score).slice(0,10).forEach(a=>console.log('  ['+a.score+'%] '+a.title))"
          exit 1
        else
          echo "✅ All scores meet thresholds!"
        fi

  failed-audits:
    desc: List failed Lighthouse audits
    summary: |
      Show details of failed audits from the latest report
      Usage: task lighthouse:failed-audits
    cmds:
      - |
        if [ -f lighthouse-report.json ]; then
          echo "Failed audits:"
          node -e "const r=require('./lighthouse-report.json');Object.entries(r.audits).filter(([k,v])=>v.score!=null&&v.score<1).forEach(([k,v])=>console.log('  ['+Math.floor(v.score*100)+'%] '+v.title))"
        else
          echo "No lighthouse-report.json found. Run 'task lighthouse:run' first."
          exit 1
        fi
