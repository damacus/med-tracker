---
version: "3"

tasks:
  build:
    desc: Build test Docker images
    summary: |
      Build Docker images for test environment.
      Use NO_CACHE=true to force a fresh build.
      Usage: task test:build
      Usage: task test:build NO_CACHE=true
    cmds:
      - task: :internal:build
        vars:
          ENVIRONMENT: test
          NO_CACHE: '{{ .NO_CACHE | default "" }}'

  up:
    desc: Start test server
    summary: |
      Start the test server
      Creates and starts all containers in detached mode
      Database data persists between restarts
      Usage: task test:up
    cmds:
      - task: :internal:up
        vars: { ENVIRONMENT: test }

  seed:
    desc: Seed test database with fixtures
    summary: |
      Seed test database with fixtures
      Loads data from db/seeds.rb
      Safe to run multiple times (idempotent if seeds are written correctly)
      Usage: task test:seed
    cmds:
      - task: :internal:seed
        vars: { ENVIRONMENT: test }

  stop:
    desc: Stop test server
    summary: |
      Stop the test server
      Removes containers but preserves database volumes
      Usage: task test:stop
    cmds:
      - task: :internal:stop
        vars: { ENVIRONMENT: test }

  ps:
    desc: List current status of Docker Compose Stack
    summary: |
      List current status of Docker Compose Stack
      Usage: task test:ps
    cmds:
      - task: :internal:ps
        vars: { ENVIRONMENT: test }

  rebuild:
    desc: Rebuild test server (drops database)
    summary: |
      Rebuild test environment from scratch
      WARNING: This drops the database and all data!
      Use this when:
      - Database migrations have changed
      - Docker images need to be rebuilt
      - Testing migration changes
      - You want a fresh test environment
      Usage: task test:rebuild
    cmds:
      - task: :internal:stop
        vars: { ENVIRONMENT: test }
      - docker compose -p medtracker-test -f docker-compose.test.yml down -v # Remove volumes (drops database)
      - task: :internal:build
        vars: { ENVIRONMENT: test }
      - task: :internal:up
        vars: { ENVIRONMENT: test }
      - task: :internal:run
        vars:
          ENVIRONMENT: test
          SERVICE: web
          COMMAND: "rails db:create db:migrate"
      - task: :internal:seed
        vars: { ENVIRONMENT: test }

  logs:
    desc: View test server logs
    summary: |
      View and follow test server logs
      Press Ctrl+C to stop following
      Usage: task test:logs
    cmds:
      - task: :internal:logs
        vars: { ENVIRONMENT: test }
