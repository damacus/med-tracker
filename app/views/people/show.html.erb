<div class="container mx-auto px-4 py-8">
  <% if notice %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
      <span class="block sm:inline"><%= notice %></span>
    </div>
  <% end %>

  <div class="max-w-4xl mx-auto">
    <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-6">
      <div class="px-6 py-4">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-3xl font-bold"><%= @person.name %></h1>
          <div class="space-x-2">
            <%= link_to "Edit", edit_person_path(@person), class: "bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded" %>
            <%= link_to "Back", people_path, class: "bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded" %>
          </div>
        </div>
        
        <div class="mb-6">
          <p class="text-gray-600">Born: <%= @person.date_of_birth.strftime("%B %d, %Y") %></p>
          <p class="text-gray-600">Age: <%= @person.age %></p>
        </div>
      </div>
    </div>

    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="px-6 py-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Prescriptions</h2>
          <%= link_to "Add Prescription", new_person_prescription_path(@person), 
              class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
        </div>

        <div class="space-y-4">
          <% @prescriptions.each do |prescription| %>
            <div id="prescription_<%= prescription.id %>" class="card">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-xl font-semibold mb-2"><%= prescription.medicine.name %></h3>
                  <p class="text-gray-600">Dosage: <%= prescription.dosage %></p>
                  <p class="text-gray-600">Frequency: <%= prescription.frequency %></p>
                  <p class="text-gray-600">Started: <%= prescription.start_date.strftime("%B %d, %Y") %></p>
                  <% if prescription.end_date %>
                    <p class="text-gray-600">Ends: <%= prescription.end_date.strftime("%B %d, %Y") %></p>
                  <% end %>
                  <% if prescription.notes.present? %>
                    <p class="text-gray-600 mt-2">Notes: <%= prescription.notes %></p>
                  <% end %>

                  <div class="mt-4">
                    <h4 class="font-semibold mb-2">Today's takes:</h4>
                    <% todays_takes = prescription.take_medicines.where("taken_at >= ?", Time.current.beginning_of_day) %>
                    <% if todays_takes.any? %>
                      <ul class="space-y-1">
                        <% todays_takes.order(taken_at: :desc).each do |take| %>
                          <li class="flex items-center space-x-2">
                            <svg class="icon icon-xs text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="12" height="12">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            <span><%= take.taken_at.strftime("%l:%M %p").strip %></span>
                          </li>
                        <% end %>
                      </ul>
                    <% else %>
                      <p class="text-gray-500">No medications taken today</p>
                    <% end %>

                    <%= form_with url: take_medicine_person_prescription_path(@person, prescription), method: :post, class: "mt-2" do |f| %>
                      <div class="flex items-center space-x-2">
                        <%= f.label :amount_ml, "Amount (ml)", class: "sr-only" %>
                        <%= f.number_field :amount_ml, value: prescription.dosage.to_f, step: 0.5, min: 0, class: "form-input w-24" %>
                        <%= f.submit "Take Now", class: "button button--primary" %>
                      </div>
                    <% end %>
                  </div>
                </div>
                
                <div class="flex space-x-2">
                  <%= link_to edit_person_prescription_path(@person, prescription), class: "button" do %>
                    <svg class="icon icon-xs" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="12" height="12">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span>Edit</span>
                  <% end %>
                  <%= button_to person_prescription_path(@person, prescription),
                      method: :delete,
                      class: "button button--danger",
                      form: { data: { turbo_confirm: "Are you sure?" } } do %>
                    <svg class="icon icon-xs" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="12" height="12">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span>Delete</span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>

          <% if @prescriptions.empty? %>
            <p class="text-gray-500 text-center py-4">No prescriptions yet.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
