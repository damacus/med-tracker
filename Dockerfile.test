# syntax=docker/dockerfile:1
# Test environment Dockerfile with Playwright
# Based on main Dockerfile with test modifications

FROM ruby:3.4.7-slim AS test-assets
LABEL maintainer="Nick Janetakis <nick.janetakis@gmail.com>"

WORKDIR /app

ARG UID=1000
ARG GID=1000

RUN bash -c "set -o pipefail \
    && groupadd -g \"${GID}\" ruby \
    && useradd --create-home --no-log-init -u \"${UID}\" -g \"${GID}\" ruby \
    && mkdir /node_modules && chown ruby:ruby -R /node_modules /app"

RUN bash -c "set -o pipefail && apt-get update \
    && apt-get install -y --no-install-recommends build-essential curl git libpq-dev libyaml-dev postgresql-client ca-certificates \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key -o /etc/apt/keyrings/nodesource.asc \
    && echo 'deb [signed-by=/etc/apt/keyrings/nodesource.asc] https://deb.nodesource.com/node_22.x nodistro main' | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update && apt-get install -y --no-install-recommends nodejs \
    && corepack enable \
    && rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man \
    && apt-get clean"

# Playwright dependencies from official docs
RUN bash -c "set -o pipefail && apt-get update \
  && apt-get install -y --no-install-recommends \
  libnss3 \
  libatk-bridge2.0-0 \
  libdrm2 \
  libxkbcommon0 \
  libxcomposite1 \
  libxdamage1 \
  libxrandr2 \
  libgbm1 \
  libxss1 \
  libasound2 \
  && rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man \
  && apt-get clean"

COPY --chown=ruby:ruby package.json *yarn* ./

# Set Playwright to use a shared browser path
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# Install Playwright browsers as root (requires root for system dependencies)
RUN npx playwright install --with-deps chromium && \
    chmod -R 755 /ms-playwright

USER ruby

COPY --chown=ruby:ruby Gemfile* ./
ARG RAILS_ENV="test"
ARG NODE_ENV="test"
ENV RAILS_ENV="${RAILS_ENV}" \
  NODE_ENV="${NODE_ENV}" \
  PATH="${PATH}:/home/ruby/.local/bin:/node_modules/.bin" \
  USER="ruby" \
  PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

COPY --chown=ruby:ruby bin/docker-entrypoint-test ./bin/
RUN chmod +x bin/docker-entrypoint-test

COPY --chown=ruby:ruby . .

ENTRYPOINT ["/app/bin/docker-entrypoint-test"]

CMD ["bundle", "exec", "rspec"]
