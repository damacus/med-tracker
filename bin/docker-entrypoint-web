#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [[ -z "${LD_PRELOAD+x}" ]]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

echo "Installing gems..."
bundle install

# Detect if the final command is "rails server"
is_server=false
if [[ "${*: -2:1}" == "rails" ]] && [[ "${*: -1:1}" == "server" ]]; then
  is_server=true
fi

# Asset precompilation only needed for server mode
if [[ "$is_server" == "true" ]]; then
  if [[ ! -f "public/assets/.manifest.json" ]]; then
    echo "Precompiling assets..."
    ./bin/rails assets:precompile
  else
    echo "Assets already compiled."
  fi
fi

# Database preparation
if ! bundle exec rails runner "ActiveRecord::Base.connection.table_exists?('schema_migrations')" 2>/dev/null; then
  echo "Loading schema..."
  ./bin/rails db:schema:load
else
  echo "Database exists, checking for pending migrations..."
  if ./bin/rails db:migrate:status | grep -q "^\s*down"; then
    echo "Running pending migrations..."
    ./bin/rails db:migrate
  else
    echo "Database is up to date."
  fi
fi

exec "${@}"
