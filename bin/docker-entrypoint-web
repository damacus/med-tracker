#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [[ -z "${LD_PRELOAD+x}" ]]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# In development, remove stale precompiled assets so Propshaft serves dynamically.
# In production/test, precompile if the manifest is missing (Dockerfile handles this
# at build time for non-dev, so this is a safety net only).
if [[ "$RAILS_ENV" == "development" ]]; then
  if [[ -f "public/assets/.manifest.json" ]]; then
    echo "Removing stale precompiled assets (development uses dynamic serving)..."
    rm -rf public/assets
  fi
elif [[ ! -f "public/assets/.manifest.json" ]]; then
  echo "Precompiling assets..."
  SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile
fi

# Database: create if missing, load schema if empty, run pending migrations.
# Idempotent â€” safe to run on every container start.
echo "Preparing database..."
./bin/rails db:prepare

exec "${@}"
