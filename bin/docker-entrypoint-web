#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [[ -z "${LD_PRELOAD+x}" ]]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Asset handling (skip for test — tests don't serve compiled assets).
if [[ "$RAILS_ENV" == "development" ]]; then
  # Development uses Propshaft dynamic serving; remove stale precompiled assets.
  if [[ -f "public/assets/.manifest.json" ]]; then
    echo "Removing stale precompiled assets (development uses dynamic serving)..."
    rm -rf public/assets
  fi
elif [[ "$RAILS_ENV" != "test" && ! -f "public/assets/.manifest.json" ]]; then
  # Production safety net — Dockerfile precompiles at build time.
  echo "Precompiling assets..."
  SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile
fi

# Database: create if missing, load schema if empty, run pending migrations.
# Idempotent — safe to run on every container start.
echo "Preparing database..."
./bin/rails db:prepare

exec "${@}"
