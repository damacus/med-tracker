#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [[ -z "${LD_PRELOAD+x}" ]]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Asset handling
if [[ "$RAILS_ENV" == "development" ]]; then
  # Development uses Propshaft dynamic serving; remove stale precompiled assets.
  if [[ -f "public/assets/.manifest.json" ]]; then
    echo "Removing stale precompiled assets (development uses dynamic serving)..."
    rm -rf public/assets
  fi
elif [[ "$RAILS_ENV" == "test" ]]; then
  # Test: volume mount overrides built image assets, so build Tailwind CSS from
  # mounted source files so Propshaft can resolve stylesheet_link_tag "tailwind".
  if [[ ! -f "app/assets/builds/tailwind.css" ]]; then
    echo "Building Tailwind CSS for test environment..."
    SECRET_KEY_BASE_DUMMY=1 ./bin/rails tailwindcss:build
  fi
elif [[ ! -f "public/assets/.manifest.json" ]]; then
  # Production safety net — Dockerfile precompiles at build time.
  echo "Precompiling assets..."
  SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile
fi

# Database: create if missing, load schema if empty, run pending migrations.
# Idempotent — safe to run on every container start.
echo "Preparing database..."
./bin/rails db:prepare

exec "${@}"
