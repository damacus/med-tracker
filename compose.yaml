---
services:
  # === Development (profile: dev) ===
  db-dev:
    extends:
      file: compose/base.yml
      service: postgres
    profiles: [dev]
    networks: [dev]
    volumes:
      - medtracker_dev_postgres:/var/lib/postgresql/data

  web-dev:
    extends:
      file: compose/base.yml
      service: rails
    profiles: [dev]
    networks: [dev]
    build:
      target: assets
      args:
        RAILS_ENV: development
    depends_on:
      db-dev:
        condition: service_healthy
    environment:
      RAILS_ENV: development
      RAILS_FORCE_SSL: "false"
      DATABASE_URL: postgresql://medtracker:medtracker_password@db-dev:5432/medtracker
    volumes:
      - .:/app
      - medtracker_dev_bundle:/usr/local/bundle
      - medtracker_dev_node_modules:/app/node_modules
      - medtracker_dev_storage:/app/storage

  # === Test (profile: test) ===
  db-test:
    extends:
      file: compose/base.yml
      service: postgres
    profiles: [test]
    networks: [test]
    healthcheck:
      interval: 5s
      timeout: 3s

  web-test:
    extends:
      file: compose/base.yml
      service: rails
    profiles: [test]
    networks: [test]
    build:
      dockerfile: Dockerfile.test
    depends_on:
      db-test:
        condition: service_healthy
    environment:
      RAILS_ENV: test
      DATABASE_URL: postgresql://medtracker:medtracker_password@db-test:5432/medtracker
    volumes:
      - .:/app
      - medtracker_test_bundle:/usr/local/bundle
      - medtracker_test_node_modules:/app/node_modules
      - ./tmp/capybara:/app/tmp/capybara
    healthcheck:
      disable: true

  # === Production (profile: prod) ===
  db-prod:
    extends:
      file: compose/base.yml
      service: postgres
    profiles: [prod]
    networks: [prod]
    volumes:
      - medtracker_prod_postgres:/var/lib/postgresql/data

  web-prod:
    extends:
      file: compose/base.yml
      service: rails
    profiles: [prod]
    networks: [prod]
    depends_on:
      db-prod:
        condition: service_healthy
    environment:
      RAILS_ENV: production
      DATABASE_URL: postgresql://medtracker:medtracker_password@db-prod:5432/medtracker
    volumes:
      - medtracker_prod_storage:/rails/storage
      - ./config/credentials/production.key:/app/config/credentials/production.key:ro
    healthcheck:
      interval: 30s
      timeout: 10s
      start_period: 60s

networks:
  dev:
  test:
  prod:

volumes:
  medtracker_dev_postgres:
  medtracker_dev_bundle:
  medtracker_dev_node_modules:
  medtracker_dev_storage:
  medtracker_test_bundle:
  medtracker_test_node_modules:
  medtracker_prod_postgres:
  medtracker_prod_storage:
