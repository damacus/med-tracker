# MedTracker - Coding Agent Progress

## Latest Session: December 1, 2025 (OpenTelemetry Observability)

### Summary
Implemented OpenTelemetry observability for MedTracker. Added SDK initialization, automatic instrumentation
for Rails/ActiveRecord/Rack/PG, and custom instrumentation for MedicationTake model.

### Changes Made
1. **Gemfile**: Added opentelemetry-sdk, opentelemetry-exporter-otlp, opentelemetry-instrumentation-all
2. **config/initializers/opentelemetry.rb**: SDK configuration with service name 'medtracker'
3. **app/models/concerns/otel_instrumented.rb**: Reusable concern for custom span creation
4. **app/models/medication_take.rb**: Added OtelInstrumented concern with custom attributes
5. **spec/config/initializers/opentelemetry_spec.rb**: Tests for SDK initialization
6. **spec/models/concerns/otel_instrumented_spec.rb**: Tests for custom instrumentation
7. **features/observability.json**: Marked 6 features as passing

### Features Implemented
- **OTEL-001**: SDK initialized with service name 'medtracker' ✓
- **OTEL-002**: HTTP requests generate traces via Rack instrumentation ✓
- **OTEL-003**: Database queries generate spans via ActiveRecord/PG instrumentation ✓
- **OTEL-004**: Custom spans for MedicationTake with prescription/person_medicine attributes ✓
- **OTEL-006**: W3C trace context propagation (default propagator) ✓
- **OTEL-013**: Health check endpoints (/up, /health, etc.) excluded from tracing ✓

### Configuration Highlights
- Service name: 'medtracker'
- Untraced endpoints: /up, /health, /healthz, /ready, /live
- PG instrumentation includes SQL statements and peer_service attribute
- Net::HTTP instrumentation excludes localhost requests

### Test Results
- 466 examples, 0 failures, 13 pending
- 10 new OpenTelemetry-specific tests added

### Remaining Observability Features (10)
- OTEL-005: Error traces capture exceptions
- OTEL-007-009: Metrics instrumentation
- OTEL-010: Structured logging with trace correlation
- OTEL-011-012: OTLP exporter and sampling configuration
- OTEL-014: Sensitive data scrubbing
- OTEL-015: Background job tracing with Solid Queue
- OTEL-016: Complete integration test

---

## Previous Session: November 28, 2025 (CARER-010 Implementation)

### Summary
Implemented CARER-010: Capacity validation requires carer for patients without capacity.
All 10 carer_relationships features now pass.

### Changes Made
1. **app/models/person.rb**: Added `carer_required_when_lacking_capacity` validation
2. **app/views/people/_form.html.erb**: Added person_type and has_capacity fields with helpful hints
3. **app/controllers/people_controller.rb**: Added person_type and has_capacity to permitted params
4. **spec/models/person_spec.rb**: Added 5 new tests for carer requirement validation
5. **spec/models/carer_relationship_spec.rb**: Fixed test to use has_capacity: true
6. **features/carer_relationships.json**: Marked CARER-010 as passing
7. **docker-compose.dev.yml**: Added command to start Rails server

### Validation Logic
- Person with `has_capacity: false` must have at least one carer assigned
- Validation checks `carer_relationships.any?` to allow building relationships before save
- Error message: "A person without capacity must have at least one carer assigned"

### Test Results
- 456 examples, 0 failures, 13 pending
- All carer_relationships features: 10/10 passing

---

## Previous Session: November 28, 2025 (Rodauth Signup Implementation)

### Summary
Implemented Rodauth signup flow (AUTH-006) with Person and User creation. Verified email
verification grace period (AUTH-008) is working in non-production environments.

### Changes Made
1. **app/views/rodauth/create_account.rb**: New Phlex component for signup form
2. **app/views/rodauth/create_account.html.erb**: ERB wrapper for Phlex component
3. **app/misc/rodauth_main.rb**: Added signup hooks for Person/User creation
4. **db/migrate/20251128215600**: Make Rodauth table timestamps nullable
5. **db/migrate/20251128215700**: Make user password_digest nullable
6. **features/authentication.json**: Marked AUTH-006 and AUTH-008 as passing

### Signup Flow Now Works
1. User fills in Name, Date of Birth, Email, Password
2. Account created via Rodauth
3. Person created with correct person_type (adult/minor based on age)
4. User created with correct role (parent/minor based on age)
5. Verification email sent
6. User can login immediately (7-day grace period in non-production)

### Features Completed
- AUTH-006: Rodauth signup form creates account and person ✓
- AUTH-008: Email verification grace period in non-production ✓

### Remaining Authentication Features
- AUTH-007: Email verification required in production (needs production testing)
- AUTH-009: Google OAuth creates new account
- AUTH-010: Google OAuth links to existing account

---

## Previous Session: November 28, 2025 (Authorization Verification)

### Summary
Verified all 25 authorization features are working correctly. Fixed development environment issues.

### Fixes Made
1. **docker-compose.dev.yml**: Added `command: ["rails", "server", "-b", "0.0.0.0"]` to start Rails server
2. **db/seeds.rb**: Added `:carer_relationships` to fixture loading order
3. **app/services/spec_fixture_loader.rb**: Changed to load all fixtures at once to avoid PostgreSQL FK validation issues

### Authorization Verification Results
- **112 policy specs**: All pass
- **57 browser authorization specs**: All pass
- **9 dashboard authorization feature specs**: All pass

### Manual Browser Verification
- AUTHZ-001: Administrator can view all users ✓
- AUTHZ-002: Non-administrator denied access to admin/users ✓
- AUTHZ-006/AUTHZ-025: Carer sees only assigned patients ✓

### Staged Changes (not committed due to 1Password signing issue)
- app/services/spec_fixture_loader.rb
- db/seeds.rb
- docker-compose.dev.yml

---

## Previous Session: November 28, 2025 (Initialization)

### Summary

This session adapted the initializer workflow for an existing mature Rails application.
MedTracker already had a complete project structure, Git repository, and extensive test suite.

## Completed Tasks

### 1. Project Analysis
- Read and analyzed `docs/app_spec.txt` (685 lines of detailed specification)
- Reviewed existing documentation: `docs/design.md`, `README.md`, `agents.md`
- Analyzed implementation plans in `docs/plans/USER_MANAGEMENT_PLAN.md`
- Assessed current test coverage in `spec/` directory

### 2. Created feature_list.json
- Created comprehensive feature list with 200 test cases
- Organized by area: authentication, authorization, prescriptions, dose_tracking,
  person_medicines, dashboard, admin, carer_relationships, audit, medicines,
  people, profile, security, navigation, style, accessibility, performance,
  i18n, pwa, e2e
- Marked passing features based on existing implementation status
- Each feature has unique ID, category, area, description, steps, and passes status

### 3. Created init.sh
- Environment setup script wrapping existing Taskfile commands
- Checks for required tools (docker, task)
- Starts development server via `task dev-up`
- Seeds database with fixtures via `task dev-seed`
- Displays test user credentials and useful commands

## Feature Status Summary

### Passing (Implemented): ~140 features
- Authentication (basic): 7/12
- Authorization: 18/25
- Prescriptions: 10/10
- Dose Tracking: 12/12
- Person Medicines: 10/10
- Dashboard: 7/8
- Admin: 21/21
- Carer Relationships: 3/10
- Medicines: 10/10
- People: 15/15
- Navigation: 7/7
- Style/UI: 14/15
- Accessibility: 8/10
- Security: 7/10
- I18N: 3/5
- PWA: 3/4
- E2E: 1/5

### Not Passing (To Implement): ~60 features
Key areas needing work:
1. **Rodauth Authentication** (AUTH-006 to AUTH-010): Signup, email verification, OAuth
2. **Audit Trail** (AUDIT-001 to AUDIT-012): PaperTrail integration, admin UI
3. **Carer Relationship UI** (CARER-001 to CARER-010): Assignment interface, dashboard
4. **User Profile Management** (PROFILE-001 to PROFILE-010): Self-service features
5. **Two-Factor Authentication** (2FA-001 to 2FA-005): TOTP, backup codes
6. **User Invitations** (INVITE-001 to INVITE-005): Invitation system
7. **Performance** (PERF-001 to PERF-005): Load time, N+1 query optimization
8. **E2E Flows** (E2E-002 to E2E-005): Complex multi-step scenarios

## Files Created

1. `/feature_list.json` - 200 feature test cases
2. `/init.sh` - Development environment setup script
3. `/claude-progress.txt` - This progress summary

## Next Steps for Future Sessions

1. **Priority 1: Audit Trail (Phase 5.2)**
   - Install PaperTrail gem
   - Add auditing to User, Person, CarerRelationship, MedicationTake models
   - Create Admin::AuditLogsController
   - Build Phlex components for audit log viewer
   - Mark AUDIT-001 through AUDIT-012 as passing

2. **Priority 2: Carer Relationship UI (Phase 3.1)**
   - Create CarerRelationshipsController
   - Build assignment interface
   - Add patient dashboard for carers
   - Mark CARER-001 through CARER-010 as passing

3. **Priority 3: Rodauth Signup (Phase 1.3)**
   - Complete Rodauth signup form
   - Implement email verification
   - Add Google OAuth
   - Mark AUTH-006 through AUTH-010 as passing

## Notes

- The project uses PostgreSQL 18 exclusively (no SQLite)
- All tests run in Docker via `task test`
- Development server via `task dev-up`
- Fixtures provide realistic test data
- TDD is mandatory - all production code requires failing tests first
